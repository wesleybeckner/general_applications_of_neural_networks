
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>Computer Vision II - General Applications of Neural Networks</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
      <link rel="stylesheet" href="../styles.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114664473-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#general-applications-of-neural-networks-session-4-computer-vision-part-2-defect-detection-case-study" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="General Applications of Neural Networks" class="md-header__button md-logo" aria-label="General Applications of Neural Networks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            General Applications of Neural Networks
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Computer Vision II
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="General Applications of Neural Networks" class="md-nav__button md-logo" aria-label="General Applications of Neural Networks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    General Applications of Neural Networks
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Sessions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Sessions" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Sessions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S1_Multilayer_Perceptron/" class="md-nav__link">
        The Multilayer Perceptron
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S2_Feed_Forward_Neural_Networks/" class="md-nav__link">
        Feed Forward Neural Networks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S3_Computer_Vision_I/" class="md-nav__link">
        Computer Vision I
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Computer Vision II
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Computer Vision II
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#40-preparing-environment-and-importing-data" class="md-nav__link">
    4.0 Preparing Environment and Importing Data
  </a>
  
    <nav class="md-nav" aria-label="4.0 Preparing Environment and Importing Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#401-enabling-and-testing-the-gpu" class="md-nav__link">
    4.0.1 Enabling and testing the GPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#402-observe-tensorflow-speedup-on-gpu-relative-to-cpu" class="md-nav__link">
    4.0.2 Observe TensorFlow speedup on GPU relative to CPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#403-import-packages" class="md-nav__link">
    4.0.3 Import Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#404-load-dataset" class="md-nav__link">
    4.0.4 Load Dataset
  </a>
  
    <nav class="md-nav" aria-label="4.0.4 Load Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4040-define-global-parameters" class="md-nav__link">
    4.0.4.0 Define Global Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4041-loading-data-with-from_tensor_slices" class="md-nav__link">
    4.0.4.1 Loading data with from_tensor_slices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4042-loading-data-with-imagedatagenerator" class="md-nav__link">
    4.0.4.2 Loading Data with ImageDataGenerator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4043-loading-data-with-image_dataset_from_directory" class="md-nav__link">
    4.0.4.3 loading data with image_dataset_from_directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4044-view-images" class="md-nav__link">
    4.0.4.4 View Images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#41-understanding-the-sliding-window" class="md-nav__link">
    4.1 Understanding the Sliding Window
  </a>
  
    <nav class="md-nav" aria-label="4.1 Understanding the Sliding Window">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-stride" class="md-nav__link">
    4.1.1 Stride
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412-padding" class="md-nav__link">
    4.1.2 Padding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-1-exploring-sliding-windows" class="md-nav__link">
    üèãÔ∏è Exercise 1: Exploring Sliding Windows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#42-building-a-custom-cnn" class="md-nav__link">
    4.2 Building a Custom CNN
  </a>
  
    <nav class="md-nav" aria-label="4.2 Building a Custom CNN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-define-architecture" class="md-nav__link">
    4.2.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#421-train-and-evaluate-model" class="md-nav__link">
    4.2.1 Train and Evaluate Model
  </a>
  
    <nav class="md-nav" aria-label="4.2.1 Train and Evaluate Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4211-from_tensor_slices" class="md-nav__link">
    4.2.1.1 from_tensor_slices
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.1 from_tensor_slices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42111-evaluate" class="md-nav__link">
    4.2.1.1.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4212-tf-image_dataset_from_directory" class="md-nav__link">
    4.2.1.2 TF - image_dataset_from_directory
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.2 TF - image_dataset_from_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42121-evaluate" class="md-nav__link">
    4.2.1.2.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4213-keras-imagedatagenerator" class="md-nav__link">
    4.2.1.3 Keras - ImageDataGenerator
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.3 Keras - ImageDataGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42131-evaluate" class="md-nav__link">
    4.2.1.3.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-binary-output" class="md-nav__link">
    üèãÔ∏è Exercise 2: Binary Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#43-data-augmentation" class="md-nav__link">
    4.3 Data Augmentation
  </a>
  
    <nav class="md-nav" aria-label="4.3 Data Augmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-define-architecture" class="md-nav__link">
    4.3.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-evaluate-model" class="md-nav__link">
    4.3.2 Evaluate Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-image-preprocessing-layers" class="md-nav__link">
    üèãÔ∏è Exercise 3: Image Preprocessing Layers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#44-transfer-learning" class="md-nav__link">
    4.4 Transfer Learning
  </a>
  
    <nav class="md-nav" aria-label="4.4 Transfer Learning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-define-architecture" class="md-nav__link">
    4.4.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-train-head" class="md-nav__link">
    4.4.2 Train Head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#443-evaluate-model" class="md-nav__link">
    4.4.3 Evaluate Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-transfer-learn-with-other-base-models" class="md-nav__link">
    üèãÔ∏è Exercise 4: Transfer Learn with other Base Models
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#45-augmentation-transfer-learning" class="md-nav__link">
    4.5 Augmentation + Transfer Learning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#46-summary" class="md-nav__link">
    4.6 Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S5_Flask/" class="md-nav__link">
        Applications with Flask
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S6_Time_Series_Analysis/" class="md-nav__link">
        Time Series Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../S7_Data_Dashboards_with_Plotly_Dash/" class="md-nav__link">
        Dashboards with Plotly Dash
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../labs/L1_Neural_Network_Linearity/" class="md-nav__link">
        Neural Network Linearity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Project" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../project/P1_Monolithic/" class="md-nav__link">
        Monolithic Tic-Tac-Toe App
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Extras
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extras" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Extras
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extras/X1_Tictactoe_RNN/" class="md-nav__link">
        Reinforcement Learning Agents
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#40-preparing-environment-and-importing-data" class="md-nav__link">
    4.0 Preparing Environment and Importing Data
  </a>
  
    <nav class="md-nav" aria-label="4.0 Preparing Environment and Importing Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#401-enabling-and-testing-the-gpu" class="md-nav__link">
    4.0.1 Enabling and testing the GPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#402-observe-tensorflow-speedup-on-gpu-relative-to-cpu" class="md-nav__link">
    4.0.2 Observe TensorFlow speedup on GPU relative to CPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#403-import-packages" class="md-nav__link">
    4.0.3 Import Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#404-load-dataset" class="md-nav__link">
    4.0.4 Load Dataset
  </a>
  
    <nav class="md-nav" aria-label="4.0.4 Load Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4040-define-global-parameters" class="md-nav__link">
    4.0.4.0 Define Global Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4041-loading-data-with-from_tensor_slices" class="md-nav__link">
    4.0.4.1 Loading data with from_tensor_slices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4042-loading-data-with-imagedatagenerator" class="md-nav__link">
    4.0.4.2 Loading Data with ImageDataGenerator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4043-loading-data-with-image_dataset_from_directory" class="md-nav__link">
    4.0.4.3 loading data with image_dataset_from_directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4044-view-images" class="md-nav__link">
    4.0.4.4 View Images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#41-understanding-the-sliding-window" class="md-nav__link">
    4.1 Understanding the Sliding Window
  </a>
  
    <nav class="md-nav" aria-label="4.1 Understanding the Sliding Window">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-stride" class="md-nav__link">
    4.1.1 Stride
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412-padding" class="md-nav__link">
    4.1.2 Padding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-1-exploring-sliding-windows" class="md-nav__link">
    üèãÔ∏è Exercise 1: Exploring Sliding Windows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#42-building-a-custom-cnn" class="md-nav__link">
    4.2 Building a Custom CNN
  </a>
  
    <nav class="md-nav" aria-label="4.2 Building a Custom CNN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-define-architecture" class="md-nav__link">
    4.2.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#421-train-and-evaluate-model" class="md-nav__link">
    4.2.1 Train and Evaluate Model
  </a>
  
    <nav class="md-nav" aria-label="4.2.1 Train and Evaluate Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4211-from_tensor_slices" class="md-nav__link">
    4.2.1.1 from_tensor_slices
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.1 from_tensor_slices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42111-evaluate" class="md-nav__link">
    4.2.1.1.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4212-tf-image_dataset_from_directory" class="md-nav__link">
    4.2.1.2 TF - image_dataset_from_directory
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.2 TF - image_dataset_from_directory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42121-evaluate" class="md-nav__link">
    4.2.1.2.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4213-keras-imagedatagenerator" class="md-nav__link">
    4.2.1.3 Keras - ImageDataGenerator
  </a>
  
    <nav class="md-nav" aria-label="4.2.1.3 Keras - ImageDataGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#42131-evaluate" class="md-nav__link">
    4.2.1.3.1 Evaluate
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-binary-output" class="md-nav__link">
    üèãÔ∏è Exercise 2: Binary Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#43-data-augmentation" class="md-nav__link">
    4.3 Data Augmentation
  </a>
  
    <nav class="md-nav" aria-label="4.3 Data Augmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431-define-architecture" class="md-nav__link">
    4.3.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432-evaluate-model" class="md-nav__link">
    4.3.2 Evaluate Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-image-preprocessing-layers" class="md-nav__link">
    üèãÔ∏è Exercise 3: Image Preprocessing Layers
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#44-transfer-learning" class="md-nav__link">
    4.4 Transfer Learning
  </a>
  
    <nav class="md-nav" aria-label="4.4 Transfer Learning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441-define-architecture" class="md-nav__link">
    4.4.1 Define Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442-train-head" class="md-nav__link">
    4.4.2 Train Head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#443-evaluate-model" class="md-nav__link">
    4.4.3 Evaluate Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-transfer-learn-with-other-base-models" class="md-nav__link">
    üèãÔ∏è Exercise 4: Transfer Learn with other Base Models
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#45-augmentation-transfer-learning" class="md-nav__link">
    4.5 Augmentation + Transfer Learning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#46-summary" class="md-nav__link">
    4.6 Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<p><a href="https://colab.research.google.com/github/wesleybeckner/general_applications_of_neural_networks/blob/main/notebooks/S4_Computer_Vision_II.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<h1 id="general-applications-of-neural-networks-session-4-computer-vision-part-2-defect-detection-case-study">General Applications of Neural Networks <br> Session 4: Computer Vision Part 2 (Defect Detection Case Study)<a class="headerlink" href="#general-applications-of-neural-networks-session-4-computer-vision-part-2-defect-detection-case-study" title="Permanent link">&para;</a></h1>
<p><strong>Instructor</strong>: Wesley Beckner</p>
<p><strong>Contact</strong>: <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#119;&#101;&#115;&#108;&#101;&#121;&#98;&#101;&#99;&#107;&#110;&#101;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#119;&#101;&#115;&#108;&#101;&#121;&#98;&#101;&#99;&#107;&#110;&#101;&#114;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
<hr />
<p><br></p>
<p>In this session we will continue with our exploration of CNNs. In the previous session we discussed three flagship layers for the CNN: convolution ReLU and maximum pooling. Here we'll discuss the sliding window, how to build your custom CNN, and data augmentation for images.</p>
<p><em>images in this notebook borrowed from <a href="https://mathformachines.com/">Ryan Holbrook</a></em></p>
<p>For more information on the dataset we are using today watch this <a href="https://www.youtube.com/watch?v=4sDfwS48p0A">video</a></p>
<p><br></p>
<hr />
<p><br></p>
<p><a name='top'></a></p>
<p><a name='x.0'></a></p>
<h2 id="40-preparing-environment-and-importing-data">4.0 Preparing Environment and Importing Data<a class="headerlink" href="#40-preparing-environment-and-importing-data" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p><a name='x.0.1'></a></p>
<h3 id="401-enabling-and-testing-the-gpu">4.0.1 Enabling and testing the GPU<a class="headerlink" href="#401-enabling-and-testing-the-gpu" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>First, you'll need to enable GPUs for the notebook:</p>
<ul>
<li>Navigate to Edit‚ÜíNotebook Settings</li>
<li>select GPU from the Hardware Accelerator drop-down</li>
</ul>
<p>Next, we'll confirm that we can connect to the GPU with tensorflow:</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="n">tensorflow_version</span> <span class="mf">2.</span><span class="n">x</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">device_name</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">gpu_device_name</span><span class="p">()</span>
<span class="k">if</span> <span class="n">device_name</span> <span class="o">!=</span> <span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">:</span>
  <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s1">&#39;GPU device not found&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found GPU at: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">device_name</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Found GPU at: /device:GPU:0
</code></pre></div>

<p><a name='x.0.2'></a></p>
<h3 id="402-observe-tensorflow-speedup-on-gpu-relative-to-cpu">4.0.2 Observe TensorFlow speedup on GPU relative to CPU<a class="headerlink" href="#402-observe-tensorflow-speedup-on-gpu-relative-to-cpu" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>This example constructs a typical convolutional neural network layer over a
random image and manually places the resulting ops on either the CPU or the GPU
to compare execution speed.</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="n">tensorflow_version</span> <span class="mf">2.</span><span class="n">x</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">timeit</span>

<span class="n">device_name</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">gpu_device_name</span><span class="p">()</span>
<span class="k">if</span> <span class="n">device_name</span> <span class="o">!=</span> <span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span>
      <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">This error most likely means that this notebook is not &#39;</span>
      <span class="s1">&#39;configured to use a GPU.  Change this in Notebook Settings via the &#39;</span>
      <span class="s1">&#39;command palette (cmd/ctrl-shift-P) or the Edit menu.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">raise</span> <span class="ne">SystemError</span><span class="p">(</span><span class="s1">&#39;GPU device not found&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cpu</span><span class="p">():</span>
  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/cpu:0&#39;</span><span class="p">):</span>
    <span class="n">random_image_cpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">net_cpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">7</span><span class="p">)(</span><span class="n">random_image_cpu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">net_cpu</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gpu</span><span class="p">():</span>
  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
    <span class="n">random_image_gpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">net_gpu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">7</span><span class="p">)(</span><span class="n">random_image_gpu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">net_gpu</span><span class="p">)</span>

<span class="c1"># We run each op once to warm up; see: https://stackoverflow.com/a/45067900</span>
<span class="n">cpu</span><span class="p">()</span>
<span class="n">gpu</span><span class="p">()</span>

<span class="c1"># Run the op several times.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time (s) to convolve 32x7x7x3 filter over random 100x100x100x3 images &#39;</span>
      <span class="s1">&#39;(batch x height x width x channel). Sum of ten runs.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CPU (s):&#39;</span><span class="p">)</span>
<span class="n">cpu_time</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;cpu()&#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s2">&quot;from __main__ import cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cpu_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU (s):&#39;</span><span class="p">)</span>
<span class="n">gpu_time</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="s1">&#39;gpu()&#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s2">&quot;from __main__ import gpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gpu_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPU speedup over CPU: </span><span class="si">{}</span><span class="s1">x&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cpu_time</span><span class="o">/</span><span class="n">gpu_time</span><span class="p">)))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Time (s) to convolve 32x7x7x3 filter over random 100x100x100x3 images (batch x height x width x channel). Sum of ten runs.
CPU (s):
3.005574539999543
GPU (s):
0.03898585099977936
GPU speedup over CPU: 77x
</code></pre></div>

<p><a name='x.0.3'></a></p>
<h3 id="403-import-packages">4.0.3 Import Packages<a class="headerlink" href="#403-import-packages" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># clear memory from cpu/gpu task (skimage load method is ram intensive)</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>1984
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">exposure</span><span class="p">,</span> <span class="n">color</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">rescale</span><span class="p">,</span> <span class="n">resize</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span><span class="n">confusion_matrix</span>

<span class="c1">#importing required tf libraries</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">InputLayer</span>
<span class="kn">from</span> <span class="nn">tensorflow.data.experimental</span> <span class="kn">import</span> <span class="n">AUTOTUNE</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental</span> <span class="kn">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing</span> <span class="kn">import</span> <span class="n">image_dataset_from_directory</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span><span class="p">,</span> <span class="n">load_img</span><span class="p">,</span> <span class="n">img_to_array</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="c1"># Sync your google drive folder</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;/content/drive&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(&quot;/content/drive&quot;, force_remount=True).
</code></pre></div>

<p><a name='x.0.4'></a></p>
<h3 id="404-load-dataset">4.0.4 Load Dataset<a class="headerlink" href="#404-load-dataset" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>We will actually take a beat here today. When we started building our ML frameworks, we simply wanted our data in a numpy array to feed it into our pipeline. At some point, especially when working with images, the data becomes too large to fit into memory. For this reason we need an alternative way to import our data. With the merger of keras/tf two popular frameworks became available, <code>ImageDataGenerator</code> and <code>image_dataset_from_directory</code> both under <code>tf.keras.preprocessing.image</code>. <code>image_dataset_from_directory</code> can sometimes be faster (tf origin) but <code>ImageDataGenerator</code> is a lot simpler to use and has on-the-fly data augmentation capability (keras).</p>
<p>For a full comparison of methods visit <a href="https://towardsdatascience.com/what-is-the-best-input-pipeline-to-train-image-classification-models-with-tf-keras-eb3fe26d3cc5">this link</a></p>
<h4 id="4040-define-global-parameters">4.0.4.0 Define Global Parameters<a class="headerlink" href="#4040-define-global-parameters" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># full dataset can be attained from kaggle if you are interested</span>
<span class="c1"># https://www.kaggle.com/ravirajsinh45/real-life-industrial-dataset-of-casting-product?select=casting_data</span>

<span class="c1"># set global parameters for all import dataset methods</span>
<span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># the images actually are 300,300,3</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">seed_value</span> <span class="o">=</span> <span class="mi">42</span>

<span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;/content/drive/MyDrive/courses/tech_fundamentals/TECH_FUNDAMENTALS/data/casting_data_class_practice&#39;</span>
<span class="n">train_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/train/&#39;</span>
<span class="n">test_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/test/&#39;</span>

<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">seed</span>
<span class="n">seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span>
</code></pre></div>

<h4 id="4041-loading-data-with-from_tensor_slices">4.0.4.1 Loading data with from_tensor_slices<a class="headerlink" href="#4041-loading-data-with-from_tensor_slices" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MyImageLoader</span><span class="p">:</span> 
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>

    <span class="k">def</span> <span class="nf">imread_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_data_from_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
        <span class="c1"># type(dir) for plane/ticket/truck/etc dataset</span>
        <span class="c1"># else for impellar dataset</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)][</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filetype</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Multiple filetypes in directory, will cause error&#39;</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">filetype</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/*.</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">dirs</span><span class="p">,</span> <span class="n">load_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imread_convert</span><span class="p">)</span>

        <span class="c1"># infer labels from directory structure</span>
        <span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img_amounts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">label_names</span><span class="p">,</span> <span class="n">img_amounts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="c1">#create one large array of image data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">concatenate_images</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span>

        <span class="c1">#resize to target shape (memory intensive)</span>
        <span class="c1"># data = resize(data, (data.shape[0], *image_shape[:2])) #uncomment if you need to resize images</span>
        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>

<span class="c1"># Create an object of the class `MyImageLoader`</span>
<span class="n">img_clf</span> <span class="o">=</span> <span class="n">MyImageLoader</span><span class="p">()</span>

<span class="c1"># load images</span>
<span class="p">(</span><span class="n">train_val_raw</span><span class="p">,</span> <span class="n">train_val_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">img_clf</span><span class="o">.</span><span class="n">load_data_from_folder</span><span class="p">(</span><span class="s1">&#39;/train/&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="n">test_raw</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">img_clf</span><span class="o">.</span><span class="n">load_data_from_folder</span><span class="p">(</span><span class="s1">&#39;/test/&#39;</span><span class="p">)</span>
<span class="n">train_val_raw</span> <span class="o">=</span> <span class="n">train_val_raw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">test_raw</span> <span class="o">=</span> <span class="n">test_raw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_val_labels</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classes: </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train and validation labels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_val_labels</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test labels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)))</span>

<span class="c1"># convert labels to numeric</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
    <span class="n">train_val_labels</span><span class="p">[</span><span class="n">train_val_labels</span> <span class="o">==</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">test_labels</span><span class="p">[</span><span class="n">test_labels</span> <span class="o">==</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>

<span class="n">train_val_labels</span> <span class="o">=</span> <span class="n">train_val_labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">test_labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># create train/val/test and shuffle</span>
<span class="n">train_val_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">train_val_raw</span><span class="p">,</span> <span class="n">train_val_labels</span><span class="p">))</span> 
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">test_raw</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">))</span> 

<span class="n">train_val_dataset</span> <span class="o">=</span> <span class="n">train_val_dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_val_dataset</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>     


<span class="c1"># use validation_split</span>
<span class="n">val_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_split</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_val_raw</span><span class="p">))</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">train_val_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">val_len</span><span class="p">)</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_val_dataset</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">val_len</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Val size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Test size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># batch the data</span>
<span class="n">train_dataset_batched</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">val_dataset_batched</span> <span class="o">=</span> <span class="n">val_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<span class="n">test_dataset_batched</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset_batched</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Val batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset_batched</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Test batches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset_batched</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Classes: [&#39;def_front&#39;, &#39;ok_front&#39;]
train and validation labels: 840
test labels: 678
Train size: 756
Val size: 84
Test size: 678
Train batches: 24
Val batches: 3
Test batches: 22
</code></pre></div>

<p><a name='x.0.4.1'></a></p>
<h4 id="4042-loading-data-with-imagedatagenerator">4.0.4.2 Loading Data with <code>ImageDataGenerator</code><a class="headerlink" href="#4042-loading-data-with-imagedatagenerator" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">image_gen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span>
                               <span class="n">validation_split</span><span class="o">=</span><span class="n">validation_split</span><span class="p">)</span> <span class="c1"># normalize pixels to 0-1</span>

<span class="c1">#we&#39;re using keras inbuilt function to ImageDataGenerator so we </span>
<span class="c1"># dont need to label all images into 0 and 1 </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading training set...&quot;</span><span class="p">)</span>
<span class="n">train_set_keras</span> <span class="o">=</span> <span class="n">image_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span>
                                          <span class="n">target_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">class_mode</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
                                          <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading validation set...&quot;</span><span class="p">)</span>
<span class="n">val_set_keras</span> <span class="o">=</span> <span class="n">image_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span>
                                          <span class="n">target_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">class_mode</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
                                          <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading testing set...&quot;</span><span class="p">)</span>
<span class="n">test_set_keras</span> <span class="o">=</span> <span class="n">image_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">test_path</span><span class="p">,</span>
                                          <span class="n">target_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
                                          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                          <span class="n">class_mode</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>loading training set...
Found 757 images belonging to 2 classes.
loading validation set...
Found 83 images belonging to 2 classes.
loading testing set...
Found 678 images belonging to 2 classes.
</code></pre></div>

<p><a name='x.0.4.2'></a></p>
<h4 id="4043-loading-data-with-image_dataset_from_directory">4.0.4.3 loading data with <code>image_dataset_from_directory</code><a class="headerlink" href="#4043-loading-data-with-image_dataset_from_directory" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<p>This method should be approx 2x faster than <code>ImageDataGenerator</code></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Load training and validation sets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading training set...&quot;</span><span class="p">)</span>
<span class="n">ds_train_</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span>
    <span class="n">train_path</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;inferred&quot;</span><span class="p">,</span>
    <span class="n">label_mode</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
    <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">validation_split</span><span class="o">=</span><span class="n">validation_split</span><span class="p">,</span>
    <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading validation set...&quot;</span><span class="p">)</span>
<span class="n">ds_val_</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span>
    <span class="n">train_path</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;inferred&quot;</span><span class="p">,</span>
    <span class="n">label_mode</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
    <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">validation_split</span><span class="o">=</span><span class="n">validation_split</span><span class="p">,</span>
    <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loading testing set...&quot;</span><span class="p">)</span>
<span class="n">ds_test_</span> <span class="o">=</span> <span class="n">image_dataset_from_directory</span><span class="p">(</span>
    <span class="n">test_path</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;inferred&quot;</span><span class="p">,</span>
    <span class="n">label_mode</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
    <span class="n">color_mode</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="n">image_shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">train_set_tf</span> <span class="o">=</span> <span class="n">ds_train_</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="n">val_set_tf</span> <span class="o">=</span> <span class="n">ds_val_</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
<span class="n">test_set_tf</span> <span class="o">=</span> <span class="n">ds_test_</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">AUTOTUNE</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>loading training set...
Found 840 files belonging to 2 classes.
Using 756 files for training.
loading validation set...
Found 840 files belonging to 2 classes.
Using 84 files for validation.
loading testing set...
Found 678 files belonging to 2 classes.
</code></pre></div>

<h4 id="4044-view-images">4.0.4.4 View Images<a class="headerlink" href="#4044-view-images" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># view some images</span>
<span class="n">def_path</span> <span class="o">=</span> <span class="s1">&#39;/def_front/cast_def_0_1001.jpeg&#39;</span>
<span class="n">ok_path</span> <span class="o">=</span> <span class="s1">&#39;/ok_front/cast_ok_0_1.jpeg&#39;</span>
<span class="n">image_path</span> <span class="o">=</span> <span class="n">train_path</span> <span class="o">+</span> <span class="n">ok_path</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
                <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_20_0.png" /></p>
<p><a name='x.1'></a></p>
<h2 id="41-understanding-the-sliding-window">4.1 Understanding the Sliding Window<a class="headerlink" href="#41-understanding-the-sliding-window" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p>The kernels we just reviewed, need to be swept or <em>slid</em> along the preceding layer. We call this a <strong><em>sliding window</em></strong>, the window being the kernel. </p>
<p align=center>
<img src="https://raw.githubusercontent.com/wesleybeckner/general_applications_of_neural_networks/main/assets/LueNK6b.gif" width=400></img>
</p>

<p>What do you notice about the gif? One perhaps obvious observation is that you can't scoot all the way up to the border of the input layer, this is because the kernel defines operations <em>around</em> the centered pixel and so you bang up against the margin of the input array. We can change the behavior at the boundary with a <strong><em>padding</em></strong> hyperparameter. A second observation, is that the distance we move the kernel along in each step could be variable, we call this the <strong><em>stride</em></strong>. We will explore the affects of each of these.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                  <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                  <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                  <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="c1"># More layers follow</span>
<span class="p">])</span>
</code></pre></div>

<p><a name='x.1.1'></a></p>
<h3 id="411-stride">4.1.1 Stride<a class="headerlink" href="#411-stride" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>Stride defines the the step size we take with each kernel as it passes along the input array. The stride needs to be defined in both the horizontal and vertical dimensions. This animation shows a 2x2 stride</p>
<p align=center>
<img src="https://raw.githubusercontent.com/wesleybeckner/general_applications_of_neural_networks/main/assets/Tlptsvt.gif" width=400></img>
</p>

<p>The stride will often be 1 for CNNs, where we don't want to lose any important information. Maximum pooling layers will often have strides greater than 1, to better summarize/accentuate the relevant features/activations.</p>
<p>If the stride is the same in both the horizontal and vertical directions, it can be set with a single number like <code>strides=2</code> within keras.</p>
<h3 id="412-padding">4.1.2 Padding<a class="headerlink" href="#412-padding" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>Padding attempts to resolve our issue at the border: our kernel requires information surrounding the centered pixel, and at the border of the input array we don't have that information. What to do?</p>
<p>We have a couple popular options within the keras framework. We can set <code>padding='valid'</code> and only slide the kernel to the edge of the input array. This has the drawback of feature maps shrinking in size as we pass through the NN. Another option is to set <code>padding='same'</code> what this will do is pad the input array with 0's, just enough of them to allow the feature map to be the same size as the input array. This is shown in the gif below:</p>
<p align=center>
<img src="https://raw.githubusercontent.com/wesleybeckner/general_applications_of_neural_networks/main/assets/RvGM2xb.gif" width=400></img>
</p>

<p>The downside of setting the padding to same will be that features at the edges of the image will be diluted. </p>
<p><a name='x.1.3'></a></p>
<h3 id="exercise-1-exploring-sliding-windows">üèãÔ∏è Exercise 1: Exploring Sliding Windows<a class="headerlink" href="#exercise-1-exploring-sliding-windows" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">draw</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="c1"># helper functions borrowed from Ryan Holbrook</span>
<span class="c1"># https://mathformachines.com/</span>

<span class="k">def</span> <span class="nf">circle</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r_shrink</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">draw</span><span class="o">.</span><span class="n">circle_perimeter</span><span class="p">(</span>
        <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r_shrink</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">circle</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">circle</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">circle</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">circle</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">circle</span>

<span class="k">def</span> <span class="nf">show_kernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_size</span><span class="o">=</span><span class="mi">28</span><span class="p">):</span>
    <span class="c1"># Format kernel</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">digits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>

    <span class="c1"># Plot kernel</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Blues_r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">kernel</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># Optionally, add value labels</span>
    <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="n">cmap</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> 
                     <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">text_size</span><span class="p">,</span>
                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>

<span class="k">def</span> <span class="nf">show_extraction</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                    <span class="n">kernel</span><span class="p">,</span>
                    <span class="n">conv_stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">conv_padding</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                    <span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">pool_stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">pool_padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                    <span class="n">subplot_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">ops</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Detect&#39;</span><span class="p">,</span> <span class="s1">&#39;Condense&#39;</span><span class="p">],</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="c1"># Create Layers</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
                        <span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                        <span class="n">strides</span><span class="o">=</span><span class="n">conv_stride</span><span class="p">,</span>
                        <span class="n">padding</span><span class="o">=</span><span class="n">conv_padding</span><span class="p">,</span>
                        <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="n">activation</span><span class="p">),</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span>
                        <span class="n">pool_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span>
                        <span class="n">strides</span><span class="o">=</span><span class="n">pool_stride</span><span class="p">,</span>
                        <span class="n">padding</span><span class="o">=</span><span class="n">pool_padding</span><span class="p">,</span>
                    <span class="p">),</span>
                   <span class="p">])</span>

    <span class="n">layer_filter</span><span class="p">,</span> <span class="n">layer_detect</span><span class="p">,</span> <span class="n">layer_condense</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">layer_filter</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">kernel</span><span class="p">])</span>

    <span class="c1"># Format for TF</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> 

    <span class="c1"># Extract Feature</span>
    <span class="n">image_filter</span> <span class="o">=</span> <span class="n">layer_filter</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">image_detect</span> <span class="o">=</span> <span class="n">layer_detect</span><span class="p">(</span><span class="n">image_filter</span><span class="p">)</span>
    <span class="n">image_condense</span> <span class="o">=</span> <span class="n">layer_condense</span><span class="p">(</span><span class="n">image_detect</span><span class="p">)</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;Input&#39;</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">images</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Input&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;Filter&#39;</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">images</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Filter&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">image_filter</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;Detect&#39;</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">images</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Detect&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">image_detect</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s1">&#39;Condense&#39;</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
        <span class="n">images</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Condense&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">image_condense</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)})</span>

    <span class="c1"># Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">title</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="o">*</span><span class="n">subplot_shape</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">adjust_gamma</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">gamma</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</code></pre></div>

<p>Create an image and kernel:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">autolayout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">labelweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span>
       <span class="n">titleweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">titlesize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">titlepad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>

<span class="n">image</span> <span class="o">=</span> <span class="n">circle</span><span class="p">([</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> <span class="n">val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">r_shrink</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="c1"># Bottom sobel</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
    <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
     <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
<span class="p">)</span>

<span class="n">show_kernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_28_0.png" /></p>
<p>What do we think this kernel is meant to detect for?</p>
<p>We will apply our kernel with a 1x1 stride and our max pooling with a 2x2 stride and pool size of 2.</p>
<div class="codehilite"><pre><span></span><code><span class="n">show_extraction</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>

    <span class="c1"># Window parameters</span>
    <span class="n">conv_stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">pool_stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>

    <span class="n">subplot_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_30_0.png" /></p>
<p>Works ok! what about a higher conv stride?</p>
<div class="codehilite"><pre><span></span><code><span class="n">show_extraction</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span>

    <span class="c1"># Window parameters</span>
    <span class="n">conv_stride</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">pool_stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>

    <span class="n">subplot_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_32_0.png" /></p>
<p>Looks like we lost a bit of information!</p>
<p>Sometimes published models will use a larger kernel and stride in the initial layer to produce large-scale features early on in the network without losing too much information (ResNet50 uses 7x7 kernels with a stride of 2). For now, without having much experience it's safe to set conv strides to 1.</p>
<p>Take a moment here with the given kernel and explore different settings for applying both the kernel and the max_pool</p>
<div class="codehilite"><pre><span></span><code>conv_stride=YOUR_VALUE, # condenses pixels
pool_size=YOUR_VALUE,
pool_stride=YOUR_VALUE, # condenses pixels
</code></pre></div>

<p>Given a total condensation of 8 (I'm taking condensation to mean <code>conv_stride</code> x <code>pool_stride</code>). what do you think is the best combination of values for <code>conv_stride, pool_size, and pool_stride</code>?</p>
<p><a name='x.2'></a></p>
<h2 id="42-building-a-custom-cnn">4.2 Building a Custom CNN<a class="headerlink" href="#42-building-a-custom-cnn" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p>As we move through the network, small-scale features (lines, edges, etc.) turn to large-scale features (shapes, eyes, ears, etc). We call these blocks of convolution, ReLU, and max pool <strong><em>convolutional blocks</em></strong> and they are the low level modular framework we work with. By this means, the CNN is able to design it's own features, ones suited for the classification or regression task at hand. </p>
<p>We will design a custom CNN for the Casting Defect Detection Dataset.</p>
<h3 id="421-define-architecture">4.2.1 Define Architecture<a class="headerlink" href="#421-define-architecture" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>In the following I'm going to double the filter size after the first block. This is a common pattern as the max pooling layers forces us in the opposite direction.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">build_model</span><span class="p">():</span>
  <span class="c1"># Creating model</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)))</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>

  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">224</span><span class="p">))</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>

  <span class="c1"># Last layer</span>
  <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

  <span class="n">base_learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
  <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="p">),</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">model</span>

<span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
</code></pre></div>

<p><a name='x.2.1'></a></p>
<h3 id="421-train-and-evaluate-model">4.2.1 Train and Evaluate Model<a class="headerlink" href="#421-train-and-evaluate-model" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>To save/load weights and training history:</p>
<div class="codehilite"><pre><span></span><code># model.save(&#39;inspection_of_casting_products.h5&#39;)
# model.load_weights(&#39;inspection_of_casting_products.h5&#39;)
# losses.to_csv(&#39;history_simple_model.csv&#39;, index=False)
</code></pre></div>

<h4 id="4211-from_tensor_slices">4.2.1.1 from_tensor_slices<a class="headerlink" href="#4211-from_tensor_slices" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset_batched</span><span class="p">,</span>
                      <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_dataset_batched</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">]</span>
                      <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;sequential_6&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_76 (Conv2D)          (None, 298, 298, 8)       224

 max_pooling2d_10 (MaxPoolin  (None, 149, 149, 8)      0         
 g2D)

 conv2d_77 (Conv2D)          (None, 147, 147, 16)      1168

 max_pooling2d_11 (MaxPoolin  (None, 73, 73, 16)       0         
 g2D)

 conv2d_78 (Conv2D)          (None, 71, 71, 16)        2320

 max_pooling2d_12 (MaxPoolin  (None, 35, 35, 16)       0         
 g2D)

 flatten_2 (Flatten)         (None, 19600)             0

 dense_4 (Dense)             (None, 224)               4390624

 activation_4 (Activation)   (None, 224)               0

 dense_5 (Dense)             (None, 2)                 450

=================================================================
Total params: 4,394,786
Trainable params: 4,394,786
Non-trainable params: 0
_________________________________________________________________
None
Epoch 1/30
24/24 [==============================] - 3s 115ms/step - loss: 132.9765 - accuracy: 0.5291 - val_loss: 0.6248 - val_accuracy: 0.6548
Epoch 2/30
24/24 [==============================] - 3s 109ms/step - loss: 0.6060 - accuracy: 0.6825 - val_loss: 0.3222 - val_accuracy: 0.8810
Epoch 3/30
24/24 [==============================] - 3s 108ms/step - loss: 0.4163 - accuracy: 0.8056 - val_loss: 0.3163 - val_accuracy: 0.8452
Epoch 4/30
24/24 [==============================] - 3s 110ms/step - loss: 0.2827 - accuracy: 0.8942 - val_loss: 0.2194 - val_accuracy: 0.8810
Epoch 5/30
24/24 [==============================] - 3s 115ms/step - loss: 0.2101 - accuracy: 0.9206 - val_loss: 0.1556 - val_accuracy: 0.9286
Epoch 6/30
24/24 [==============================] - 3s 109ms/step - loss: 0.1378 - accuracy: 0.9563 - val_loss: 0.0854 - val_accuracy: 0.9881
Epoch 7/30
24/24 [==============================] - 3s 112ms/step - loss: 0.0996 - accuracy: 0.9749 - val_loss: 0.0737 - val_accuracy: 0.9881
Epoch 8/30
24/24 [==============================] - 3s 113ms/step - loss: 0.0779 - accuracy: 0.9762 - val_loss: 0.0268 - val_accuracy: 1.0000
Epoch 9/30
24/24 [==============================] - 3s 111ms/step - loss: 0.0687 - accuracy: 0.9802 - val_loss: 0.0684 - val_accuracy: 0.9762
Epoch 10/30
24/24 [==============================] - 3s 110ms/step - loss: 0.0456 - accuracy: 0.9881 - val_loss: 0.0276 - val_accuracy: 0.9762
Epoch 11/30
24/24 [==============================] - 3s 112ms/step - loss: 0.0420 - accuracy: 0.9881 - val_loss: 0.0177 - val_accuracy: 1.0000
Epoch 12/30
24/24 [==============================] - 3s 110ms/step - loss: 0.0611 - accuracy: 0.9788 - val_loss: 0.0179 - val_accuracy: 1.0000
Epoch 13/30
24/24 [==============================] - 3s 110ms/step - loss: 0.0161 - accuracy: 0.9987 - val_loss: 0.0047 - val_accuracy: 1.0000
Epoch 14/30
24/24 [==============================] - 3s 110ms/step - loss: 0.0139 - accuracy: 0.9987 - val_loss: 0.0069 - val_accuracy: 1.0000
Epoch 15/30
24/24 [==============================] - 3s 109ms/step - loss: 0.0083 - accuracy: 0.9974 - val_loss: 0.0082 - val_accuracy: 1.0000
Epoch 16/30
24/24 [==============================] - 2s 105ms/step - loss: 0.0069 - accuracy: 1.0000 - val_loss: 0.0165 - val_accuracy: 0.9881
Epoch 17/30
24/24 [==============================] - 3s 109ms/step - loss: 0.0038 - accuracy: 1.0000 - val_loss: 0.0022 - val_accuracy: 1.0000
Epoch 18/30
24/24 [==============================] - 2s 106ms/step - loss: 0.0018 - accuracy: 1.0000 - val_loss: 0.0020 - val_accuracy: 1.0000
Epoch 19/30
24/24 [==============================] - 3s 107ms/step - loss: 0.0013 - accuracy: 1.0000 - val_loss: 0.0013 - val_accuracy: 1.0000
Epoch 20/30
24/24 [==============================] - 3s 109ms/step - loss: 0.0011 - accuracy: 1.0000 - val_loss: 9.6427e-04 - val_accuracy: 1.0000
Epoch 21/30
24/24 [==============================] - 3s 109ms/step - loss: 9.7981e-04 - accuracy: 1.0000 - val_loss: 5.6754e-04 - val_accuracy: 1.0000
Epoch 22/30
24/24 [==============================] - 3s 109ms/step - loss: 8.0048e-04 - accuracy: 1.0000 - val_loss: 7.3450e-04 - val_accuracy: 1.0000
Epoch 23/30
24/24 [==============================] - 3s 108ms/step - loss: 7.3568e-04 - accuracy: 1.0000 - val_loss: 7.3688e-04 - val_accuracy: 1.0000
Epoch 24/30
24/24 [==============================] - 3s 109ms/step - loss: 6.8541e-04 - accuracy: 1.0000 - val_loss: 7.2755e-04 - val_accuracy: 1.0000
Epoch 25/30
24/24 [==============================] - 3s 108ms/step - loss: 5.7163e-04 - accuracy: 1.0000 - val_loss: 5.1711e-04 - val_accuracy: 1.0000
Epoch 26/30
24/24 [==============================] - 3s 107ms/step - loss: 5.5725e-04 - accuracy: 1.0000 - val_loss: 7.9680e-04 - val_accuracy: 1.0000
Epoch 27/30
24/24 [==============================] - 3s 111ms/step - loss: 4.6501e-04 - accuracy: 1.0000 - val_loss: 4.5257e-04 - val_accuracy: 1.0000
Epoch 28/30
24/24 [==============================] - 3s 107ms/step - loss: 4.8340e-04 - accuracy: 1.0000 - val_loss: 5.4358e-04 - val_accuracy: 1.0000
Epoch 29/30
24/24 [==============================] - 3s 107ms/step - loss: 4.5438e-04 - accuracy: 1.0000 - val_loss: 4.8173e-04 - val_accuracy: 1.0000
Epoch 30/30
24/24 [==============================] - 3s 106ms/step - loss: 3.7990e-04 - accuracy: 1.0000 - val_loss: 5.9811e-04 - val_accuracy: 1.0000
CPU times: user 1min 51s, sys: 3.35 s, total: 1min 54s
Wall time: 2min 3s
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5f78fa81d0&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_40_1.png" /></p>
<h5 id="42111-evaluate">4.2.1.1.1 Evaluate<a class="headerlink" href="#42111-evaluate" title="Permanent link">&para;</a></h5>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">pred</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dataset_batched</span><span class="p">)):</span>
  <span class="n">image_batch</span><span class="p">,</span> <span class="n">label_batch</span> <span class="o">=</span> <span class="n">test_dataset_batched</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span><span class="n">image_batch</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="c1"># print(f&quot;Labels     : {label_batch}\nPredictions: {predictions.astype(float)}&quot;)</span>
  <span class="n">pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
  <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_batch</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

         0.0       0.87      0.73      0.79       439
         1.0       0.65      0.83      0.73       265

    accuracy                           0.76       704
   macro avg       0.76      0.78      0.76       704
weighted avg       0.79      0.76      0.77       704






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5f78eeb710&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_42_2.png" /></p>
<h4 id="4212-tf-image_dataset_from_directory">4.2.1.2 TF - image_dataset_from_directory<a class="headerlink" href="#4212-tf-image_dataset_from_directory" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set_tf</span><span class="p">,</span>
                      <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_set_tf</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">]</span>
                      <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;sequential_7&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_79 (Conv2D)          (None, 298, 298, 8)       224

 max_pooling2d_13 (MaxPoolin  (None, 149, 149, 8)      0         
 g2D)

 conv2d_80 (Conv2D)          (None, 147, 147, 16)      1168

 max_pooling2d_14 (MaxPoolin  (None, 73, 73, 16)       0         
 g2D)

 conv2d_81 (Conv2D)          (None, 71, 71, 16)        2320

 max_pooling2d_15 (MaxPoolin  (None, 35, 35, 16)       0         
 g2D)

 flatten_3 (Flatten)         (None, 19600)             0

 dense_6 (Dense)             (None, 224)               4390624

 activation_5 (Activation)   (None, 224)               0

 dense_7 (Dense)             (None, 2)                 450

=================================================================
Total params: 4,394,786
Trainable params: 4,394,786
Non-trainable params: 0
_________________________________________________________________
None
Epoch 1/30
24/24 [==============================] - 3s 84ms/step - loss: 134.4261 - accuracy: 0.4907 - val_loss: 1.5429 - val_accuracy: 0.4643
Epoch 2/30
24/24 [==============================] - 2s 78ms/step - loss: 0.8067 - accuracy: 0.6310 - val_loss: 0.5859 - val_accuracy: 0.7262
Epoch 3/30
24/24 [==============================] - 2s 83ms/step - loss: 0.5311 - accuracy: 0.7526 - val_loss: 0.5008 - val_accuracy: 0.7976
Epoch 4/30
24/24 [==============================] - 2s 79ms/step - loss: 0.4654 - accuracy: 0.7804 - val_loss: 0.4791 - val_accuracy: 0.7976
Epoch 5/30
24/24 [==============================] - 2s 79ms/step - loss: 0.3286 - accuracy: 0.8505 - val_loss: 0.5123 - val_accuracy: 0.7262
Epoch 6/30
24/24 [==============================] - 2s 80ms/step - loss: 0.2423 - accuracy: 0.9087 - val_loss: 0.4219 - val_accuracy: 0.8452
Epoch 7/30
24/24 [==============================] - 2s 79ms/step - loss: 0.1751 - accuracy: 0.9458 - val_loss: 0.4531 - val_accuracy: 0.7857
Epoch 8/30
24/24 [==============================] - 2s 79ms/step - loss: 0.1511 - accuracy: 0.9656 - val_loss: 0.4535 - val_accuracy: 0.7976
Epoch 9/30
24/24 [==============================] - 2s 77ms/step - loss: 0.1301 - accuracy: 0.9590 - val_loss: 0.5098 - val_accuracy: 0.7857
Epoch 10/30
24/24 [==============================] - 2s 81ms/step - loss: 0.2029 - accuracy: 0.9087 - val_loss: 2.2267 - val_accuracy: 0.6310
Epoch 11/30
24/24 [==============================] - 2s 80ms/step - loss: 1.1712 - accuracy: 0.7262 - val_loss: 0.5656 - val_accuracy: 0.8333
CPU times: user 26.7 s, sys: 2.53 s, total: 29.2 s
Wall time: 27.3 s
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5f78c45690&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_45_1.png" /></p>
<h5 id="42121-evaluate">4.2.1.2.1 Evaluate<a class="headerlink" href="#42121-evaluate" title="Permanent link">&para;</a></h5>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set_tf</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_test_</span><span class="p">:</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

         0.0       0.96      0.80      0.87       416
         1.0       0.75      0.94      0.83       262

    accuracy                           0.85       678
   macro avg       0.85      0.87      0.85       678
weighted avg       0.88      0.85      0.86       678






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5dab15c910&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_47_2.png" /></p>
<h4 id="4213-keras-imagedatagenerator">4.2.1.3 Keras - ImageDataGenerator<a class="headerlink" href="#4213-keras-imagedatagenerator" title="Permanent link">&para;</a></h4>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set_keras</span><span class="p">,</span>
                      <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_set_keras</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">]</span>
                      <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;sequential_8&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv2d_82 (Conv2D)          (None, 298, 298, 8)       224

 max_pooling2d_16 (MaxPoolin  (None, 149, 149, 8)      0         
 g2D)

 conv2d_83 (Conv2D)          (None, 147, 147, 16)      1168

 max_pooling2d_17 (MaxPoolin  (None, 73, 73, 16)       0         
 g2D)

 conv2d_84 (Conv2D)          (None, 71, 71, 16)        2320

 max_pooling2d_18 (MaxPoolin  (None, 35, 35, 16)       0         
 g2D)

 flatten_4 (Flatten)         (None, 19600)             0

 dense_8 (Dense)             (None, 224)               4390624

 activation_6 (Activation)   (None, 224)               0

 dense_9 (Dense)             (None, 2)                 450

=================================================================
Total params: 4,394,786
Trainable params: 4,394,786
Non-trainable params: 0
_________________________________________________________________
None
Epoch 1/30
24/24 [==============================] - 5s 174ms/step - loss: 0.7278 - accuracy: 0.5561 - val_loss: 0.6366 - val_accuracy: 0.6747
Epoch 2/30
24/24 [==============================] - 4s 150ms/step - loss: 0.5721 - accuracy: 0.7028 - val_loss: 0.5733 - val_accuracy: 0.6386
Epoch 3/30
24/24 [==============================] - 4s 151ms/step - loss: 0.4539 - accuracy: 0.7900 - val_loss: 0.4812 - val_accuracy: 0.7711
Epoch 4/30
24/24 [==============================] - 4s 151ms/step - loss: 0.4377 - accuracy: 0.7794 - val_loss: 0.4864 - val_accuracy: 0.7711
Epoch 5/30
24/24 [==============================] - 4s 148ms/step - loss: 0.3481 - accuracy: 0.8468 - val_loss: 0.4426 - val_accuracy: 0.7831
Epoch 6/30
24/24 [==============================] - 4s 150ms/step - loss: 0.2842 - accuracy: 0.8838 - val_loss: 0.3726 - val_accuracy: 0.8916
Epoch 7/30
24/24 [==============================] - 4s 149ms/step - loss: 0.1982 - accuracy: 0.9379 - val_loss: 0.3101 - val_accuracy: 0.8916
Epoch 8/30
24/24 [==============================] - 4s 150ms/step - loss: 0.1527 - accuracy: 0.9564 - val_loss: 0.2488 - val_accuracy: 0.9036
Epoch 9/30
24/24 [==============================] - 4s 150ms/step - loss: 0.0921 - accuracy: 0.9802 - val_loss: 0.2471 - val_accuracy: 0.9036
Epoch 10/30
24/24 [==============================] - 4s 150ms/step - loss: 0.0782 - accuracy: 0.9775 - val_loss: 0.2200 - val_accuracy: 0.9277
Epoch 11/30
24/24 [==============================] - 4s 148ms/step - loss: 0.0493 - accuracy: 0.9934 - val_loss: 0.1825 - val_accuracy: 0.9518
Epoch 12/30
24/24 [==============================] - 4s 150ms/step - loss: 0.0319 - accuracy: 0.9947 - val_loss: 0.2291 - val_accuracy: 0.9518
Epoch 13/30
24/24 [==============================] - 4s 149ms/step - loss: 0.0205 - accuracy: 1.0000 - val_loss: 0.1718 - val_accuracy: 0.9639
Epoch 14/30
24/24 [==============================] - 4s 146ms/step - loss: 0.0146 - accuracy: 1.0000 - val_loss: 0.1609 - val_accuracy: 0.9398
Epoch 15/30
24/24 [==============================] - 4s 149ms/step - loss: 0.0159 - accuracy: 0.9987 - val_loss: 0.2507 - val_accuracy: 0.9157
Epoch 16/30
24/24 [==============================] - 4s 149ms/step - loss: 0.0288 - accuracy: 0.9921 - val_loss: 0.2198 - val_accuracy: 0.9398
Epoch 17/30
24/24 [==============================] - 4s 150ms/step - loss: 0.0166 - accuracy: 0.9987 - val_loss: 0.2413 - val_accuracy: 0.9398
Epoch 18/30
24/24 [==============================] - 4s 162ms/step - loss: 0.0113 - accuracy: 1.0000 - val_loss: 0.1890 - val_accuracy: 0.9398
Epoch 19/30
24/24 [==============================] - 4s 149ms/step - loss: 0.0047 - accuracy: 1.0000 - val_loss: 0.2061 - val_accuracy: 0.9518
CPU times: user 1min 9s, sys: 3.85 s, total: 1min 13s
Wall time: 1min 10s
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">losses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">losses</span><span class="p">[[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5db3ca5710&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_50_1.png" /></p>
<h5 id="42131-evaluate">4.2.1.3.1 Evaluate<a class="headerlink" href="#42131-evaluate" title="Permanent link">&para;</a></h5>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set_keras</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">test_set_keras</span><span class="o">.</span><span class="n">classes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

           0       0.98      0.95      0.96       416
           1       0.92      0.97      0.95       262

    accuracy                           0.96       678
   macro avg       0.95      0.96      0.96       678
weighted avg       0.96      0.96      0.96       678






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5db3ba4dd0&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_52_2.png" /></p>
<h3 id="exercise-2-binary-output">üèãÔ∏è Exercise 2: Binary Output<a class="headerlink" href="#exercise-2-binary-output" title="Permanent link">&para;</a></h3>
<p>In the above, we used a type of loss function called <em>sparse categorical crossentropy</em></p>
<p>This loss is useful when we have many target classes set as different integers, i.e.</p>
<div class="codehilite"><pre><span></span><code>good = 1
bad = 2
ugly = 3
</code></pre></div>

<p>another type of loss function is <em>categorical crossentropy</em> this is for when the target classes are one-hot encoded, i.e.</p>
<div class="codehilite"><pre><span></span><code>good = [1,0,0]
bad = [0,1,0]
ugly = [0,0,1]
</code></pre></div>

<ol>
<li>Choose one of the datatset import methods from above</li>
<li>Specify the labels as binary during the loading process</li>
<li>Redefine the model using </li>
<li>a single dense node as the final layer with</li>
<li>a sigmoidal activation function</li>
<li>Compile with the new loss set to 'binary_crossentropy',</li>
<li>Train the model</li>
<li>Evaluate the F1/Precision/Recall metrics and display the confusion matrix. </li>
<li><em>note: our prior method of obtaining the classification using <code>argmax</code> will not work, as the output is now a probability score ranging 0-1</em></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Code cell for exercise 2</span>
</code></pre></div>

<p><a name='x.3'></a></p>
<h2 id="43-data-augmentation">4.3 Data Augmentation<a class="headerlink" href="#43-data-augmentation" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p>Alright, alright, alright. We've done pretty good making our CNN model. But let's see if we can make it even better. There's a last trick we'll cover here in regard to image classifiers. We're going to perturb the input images in such a way as to create a pseudo-larger dataset.</p>
<p>With any machine learning model, the more relevant training data we give the model, the better. The key here is <em>relevant</em> training data. We can easily do this with images so long as we do not change the class of the image. For example, in the small plot below, we are changing contrast, hue, rotation, and doing other things to the image of a car; and this is okay because it does not change the classification from a car to, say, a truck.</p>
<p align=center>
<img src="https://raw.githubusercontent.com/wesleybeckner/general_applications_of_neural_networks/main/assets/UaOm0ms.png" width=400></img>
</p>

<p>Typically when we do data augmentation for images, we do them <em>online</em>, i.e. during training. Recall that we train in batches (or minibatches) with CNNs. An example of a minibatch then, might be the small multiples plot below.</p>
<p align=center>
<img src="https://raw.githubusercontent.com/wesleybeckner/general_applications_of_neural_networks/main/assets/MFviYoE.png" width=400></img>
</p>

<p>by varying the images in this way, the model always sees slightly new data, and becomes a more robust model. Remember that the caveat is that we can't muddle the relevant classification of the image. Sometimes the best way to see if data augmentation will be helpful is to just try it and see!</p>
<h3 id="431-define-architecture">4.3.1 Define Architecture<a class="headerlink" href="#431-define-architecture" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1">#Creating model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">image_shape</span><span class="p">)))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)),</span> <span class="c1"># flip left-to-right</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)),</span> <span class="c1"># flip upside-down</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomContrast</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)),</span> <span class="c1"># contrast change by up to 50%</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">input_shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>

<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">224</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>

<span class="c1"># Last layer</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                           <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                           <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>

<span class="n">base_learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;sequential_9&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 random_flip (RandomFlip)    (None, 300, 300, 3)       0

 random_flip_1 (RandomFlip)  (None, 300, 300, 3)       0

 random_contrast (RandomCont  (None, 300, 300, 3)      0         
 rast)

 random_rotation (RandomRota  (None, 300, 300, 3)      0         
 tion)

 conv2d_85 (Conv2D)          (None, 298, 298, 8)       224

 max_pooling2d_19 (MaxPoolin  (None, 149, 149, 8)      0         
 g2D)

 conv2d_86 (Conv2D)          (None, 147, 147, 16)      1168

 max_pooling2d_20 (MaxPoolin  (None, 73, 73, 16)       0         
 g2D)

 conv2d_87 (Conv2D)          (None, 71, 71, 16)        2320

 max_pooling2d_21 (MaxPoolin  (None, 35, 35, 16)       0         
 g2D)

 flatten_5 (Flatten)         (None, 19600)             0

 dense_10 (Dense)            (None, 224)               4390624

 activation_7 (Activation)   (None, 224)               0

 dense_11 (Dense)            (None, 2)                 450

=================================================================
Total params: 4,394,786
Trainable params: 4,394,786
Non-trainable params: 0
_________________________________________________________________
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set_tf</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="n">val_set_tf</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Epoch 1/30
24/24 [==============================] - 4s 91ms/step - loss: 93.7654 - accuracy: 0.5503 - val_loss: 1.5286 - val_accuracy: 0.6190
Epoch 2/30
24/24 [==============================] - 2s 83ms/step - loss: 1.0640 - accuracy: 0.6508 - val_loss: 0.6292 - val_accuracy: 0.7024
Epoch 3/30
24/24 [==============================] - 2s 84ms/step - loss: 0.6656 - accuracy: 0.6944 - val_loss: 0.5734 - val_accuracy: 0.7143
Epoch 4/30
24/24 [==============================] - 2s 83ms/step - loss: 0.5832 - accuracy: 0.7037 - val_loss: 0.5793 - val_accuracy: 0.7143
Epoch 5/30
24/24 [==============================] - 3s 86ms/step - loss: 0.5902 - accuracy: 0.7235 - val_loss: 0.5230 - val_accuracy: 0.7500
Epoch 6/30
24/24 [==============================] - 2s 83ms/step - loss: 0.5396 - accuracy: 0.7447 - val_loss: 0.5276 - val_accuracy: 0.7738
Epoch 7/30
24/24 [==============================] - 2s 84ms/step - loss: 0.4809 - accuracy: 0.7672 - val_loss: 0.4934 - val_accuracy: 0.8095
Epoch 8/30
24/24 [==============================] - 2s 85ms/step - loss: 0.4144 - accuracy: 0.8108 - val_loss: 0.4401 - val_accuracy: 0.8095
Epoch 9/30
24/24 [==============================] - 2s 84ms/step - loss: 0.3664 - accuracy: 0.8585 - val_loss: 0.3677 - val_accuracy: 0.8690
Epoch 10/30
24/24 [==============================] - 2s 83ms/step - loss: 0.4642 - accuracy: 0.7844 - val_loss: 0.4574 - val_accuracy: 0.8095
Epoch 11/30
24/24 [==============================] - 2s 84ms/step - loss: 0.3724 - accuracy: 0.8135 - val_loss: 0.3456 - val_accuracy: 0.8333
Epoch 12/30
24/24 [==============================] - 2s 83ms/step - loss: 0.2774 - accuracy: 0.8783 - val_loss: 0.3460 - val_accuracy: 0.8571
Epoch 13/30
24/24 [==============================] - 3s 86ms/step - loss: 0.2786 - accuracy: 0.8902 - val_loss: 0.2961 - val_accuracy: 0.8929
Epoch 14/30
24/24 [==============================] - 2s 83ms/step - loss: 0.2955 - accuracy: 0.8730 - val_loss: 0.3577 - val_accuracy: 0.8214
Epoch 15/30
24/24 [==============================] - 2s 83ms/step - loss: 0.3145 - accuracy: 0.8651 - val_loss: 0.2971 - val_accuracy: 0.8929
Epoch 16/30
24/24 [==============================] - 2s 84ms/step - loss: 0.2414 - accuracy: 0.9021 - val_loss: 0.2544 - val_accuracy: 0.9167
Epoch 17/30
24/24 [==============================] - 2s 81ms/step - loss: 0.2229 - accuracy: 0.9127 - val_loss: 0.2901 - val_accuracy: 0.8571
Epoch 18/30
24/24 [==============================] - 2s 82ms/step - loss: 0.2601 - accuracy: 0.9061 - val_loss: 0.1960 - val_accuracy: 0.9405
Epoch 19/30
24/24 [==============================] - 2s 84ms/step - loss: 0.2167 - accuracy: 0.9206 - val_loss: 0.2081 - val_accuracy: 0.9286
Epoch 20/30
24/24 [==============================] - 2s 83ms/step - loss: 0.2397 - accuracy: 0.8929 - val_loss: 0.2204 - val_accuracy: 0.9167
Epoch 21/30
24/24 [==============================] - 2s 84ms/step - loss: 0.2110 - accuracy: 0.9140 - val_loss: 0.2115 - val_accuracy: 0.9405
Epoch 22/30
24/24 [==============================] - 2s 83ms/step - loss: 0.1644 - accuracy: 0.9365 - val_loss: 0.2254 - val_accuracy: 0.9286
Epoch 23/30
24/24 [==============================] - 2s 84ms/step - loss: 0.1505 - accuracy: 0.9431 - val_loss: 0.2011 - val_accuracy: 0.9167
CPU times: user 57.8 s, sys: 5.24 s, total: 1min 3s
Wall time: 58.7 s
</code></pre></div>

<p><a name='x.3.1'></a></p>
<h3 id="432-evaluate-model">4.3.2 Evaluate Model<a class="headerlink" href="#432-evaluate-model" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set_tf</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_test_</span><span class="p">:</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

         0.0       0.99      0.90      0.94       416
         1.0       0.86      0.98      0.91       262

    accuracy                           0.93       678
   macro avg       0.92      0.94      0.93       678
weighted avg       0.94      0.93      0.93       678






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5db3f9a3d0&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_60_2.png" /></p>
<p><a name='x.3.2'></a></p>
<h3 id="exercise-3-image-preprocessing-layers">üèãÔ∏è Exercise 3: Image Preprocessing Layers<a class="headerlink" href="#exercise-3-image-preprocessing-layers" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<p>These layers apply random augmentation transforms to a batch of images. They are only active during training. You can visit the documentation <a href="https://keras.io/api/layers/preprocessing_layers/image_preprocessing/">here</a></p>
<ul>
<li><code>RandomCrop</code> layer</li>
<li><code>RandomFlip</code> layer</li>
<li><code>RandomTranslation</code> layer</li>
<li><code>RandomRotation</code> layer</li>
<li><code>RandomZoom</code> layer</li>
<li><code>RandomHeight</code> layer</li>
<li><code>RandomWidth</code> layer</li>
</ul>
<p>Use any combination of random augmentation transforms and retrain your model. Can you get a higher val performance? you may need to increase your epochs.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Code cell for exercise 3</span>
</code></pre></div>

<p><a name='x.4'></a></p>
<h2 id="44-transfer-learning">4.4 Transfer Learning<a class="headerlink" href="#44-transfer-learning" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p>MobileNetV2 - A general purpose, deployable computer vision neural network designed by Google that works efficiently for classification, detection and segmentation.  </p>
<p><img alt="" src="https://miro.medium.com/max/1016/1*5iA55983nBMlQn9f6ICxKg.png" /></p>
<h3 id="441-define-architecture">4.4.1 Define Architecture<a class="headerlink" href="#441-define-architecture" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1">### COMPONENTS (IN ORDER)</span>
<span class="n">resize</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Resizing</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">)</span>
<span class="n">preprocess_input_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="o">.</span><span class="n">preprocess_input</span> 
<span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                               <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span><span class="p">)</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span><span class="o">=</span><span class="kc">False</span>
<span class="n">global_average_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()</span>
<span class="n">prediction_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/mobilenet_v2/mobilenet_v2_weights_tf_dim_ordering_tf_kernels_1.0_224_no_top.h5
9412608/9406464 [==============================] - 0s 0us/step
9420800/9406464 [==============================] - 0s 0us/step
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">### MODEL</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">preprocess_input_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">global_average_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">prediction_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">base_learning_rate</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                           <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                           <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_8 (InputLayer)        [(None, 300, 300, 3)]     0

 resizing (Resizing)         (None, 224, 224, 3)       0

 tf.math.truediv (TFOpLambda  (None, 224, 224, 3)      0         
 )

 tf.math.subtract (TFOpLambd  (None, 224, 224, 3)      0         
 a)

 mobilenetv2_1.00_224 (Funct  (None, 7, 7, 1280)       2257984   
 ional)

 global_average_pooling2d (G  (None, 1280)             0         
 lobalAveragePooling2D)

 dropout (Dropout)           (None, 1280)              0

 dense_12 (Dense)            (None, 2)                 2562

=================================================================
Total params: 2,260,546
Trainable params: 2,562
Non-trainable params: 2,257,984
_________________________________________________________________


/usr/local/lib/python3.7/dist-packages/keras/optimizer_v2/adam.py:105: UserWarning: The `lr` argument is deprecated, use `learning_rate` instead.
  super(Adam, self).__init__(name, **kwargs)
</code></pre></div>

<h3 id="442-train-head">4.4.2 Train Head<a class="headerlink" href="#442-train-head" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set_tf</span><span class="p">,</span>
                      <span class="n">epochs</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_set_tf</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">]</span>
                      <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Epoch 1/50
24/24 [==============================] - 6s 130ms/step - loss: 0.8879 - accuracy: 0.4431 - val_loss: 0.7634 - val_accuracy: 0.4643
Epoch 2/50
24/24 [==============================] - 3s 86ms/step - loss: 0.8257 - accuracy: 0.4815 - val_loss: 0.6939 - val_accuracy: 0.5238
Epoch 3/50
24/24 [==============================] - 2s 85ms/step - loss: 0.7602 - accuracy: 0.5278 - val_loss: 0.6392 - val_accuracy: 0.6071
Epoch 4/50
24/24 [==============================] - 3s 87ms/step - loss: 0.6970 - accuracy: 0.5847 - val_loss: 0.5912 - val_accuracy: 0.6905
Epoch 5/50
24/24 [==============================] - 3s 86ms/step - loss: 0.6381 - accuracy: 0.6336 - val_loss: 0.5536 - val_accuracy: 0.7857
Epoch 6/50
24/24 [==============================] - 3s 88ms/step - loss: 0.6212 - accuracy: 0.6521 - val_loss: 0.5171 - val_accuracy: 0.8571
Epoch 7/50
24/24 [==============================] - 3s 87ms/step - loss: 0.5816 - accuracy: 0.6905 - val_loss: 0.4897 - val_accuracy: 0.8929
Epoch 8/50
24/24 [==============================] - 3s 87ms/step - loss: 0.5254 - accuracy: 0.7407 - val_loss: 0.4642 - val_accuracy: 0.8929
Epoch 9/50
24/24 [==============================] - 3s 86ms/step - loss: 0.5293 - accuracy: 0.7209 - val_loss: 0.4405 - val_accuracy: 0.8929
Epoch 10/50
24/24 [==============================] - 2s 86ms/step - loss: 0.4834 - accuracy: 0.7857 - val_loss: 0.4216 - val_accuracy: 0.9048
Epoch 11/50
24/24 [==============================] - 2s 85ms/step - loss: 0.5037 - accuracy: 0.7698 - val_loss: 0.4046 - val_accuracy: 0.9167
Epoch 12/50
24/24 [==============================] - 3s 86ms/step - loss: 0.4370 - accuracy: 0.8214 - val_loss: 0.3900 - val_accuracy: 0.9167
Epoch 13/50
24/24 [==============================] - 3s 87ms/step - loss: 0.4188 - accuracy: 0.8320 - val_loss: 0.3737 - val_accuracy: 0.9286
Epoch 14/50
24/24 [==============================] - 3s 87ms/step - loss: 0.4236 - accuracy: 0.8108 - val_loss: 0.3610 - val_accuracy: 0.9405
Epoch 15/50
24/24 [==============================] - 3s 86ms/step - loss: 0.4260 - accuracy: 0.8360 - val_loss: 0.3494 - val_accuracy: 0.9405
Epoch 16/50
24/24 [==============================] - 2s 86ms/step - loss: 0.3880 - accuracy: 0.8320 - val_loss: 0.3381 - val_accuracy: 0.9405
Epoch 17/50
24/24 [==============================] - 3s 87ms/step - loss: 0.3906 - accuracy: 0.8347 - val_loss: 0.3272 - val_accuracy: 0.9524
Epoch 18/50
24/24 [==============================] - 2s 86ms/step - loss: 0.3680 - accuracy: 0.8558 - val_loss: 0.3192 - val_accuracy: 0.9524
Epoch 19/50
24/24 [==============================] - 3s 85ms/step - loss: 0.3721 - accuracy: 0.8439 - val_loss: 0.3104 - val_accuracy: 0.9524
Epoch 20/50
24/24 [==============================] - 2s 85ms/step - loss: 0.3665 - accuracy: 0.8399 - val_loss: 0.3047 - val_accuracy: 0.9405
Epoch 21/50
24/24 [==============================] - 3s 86ms/step - loss: 0.3405 - accuracy: 0.8730 - val_loss: 0.2952 - val_accuracy: 0.9524
Epoch 22/50
24/24 [==============================] - 3s 86ms/step - loss: 0.3359 - accuracy: 0.8757 - val_loss: 0.2867 - val_accuracy: 0.9524
Epoch 23/50
24/24 [==============================] - 3s 87ms/step - loss: 0.3314 - accuracy: 0.8690 - val_loss: 0.2822 - val_accuracy: 0.9524
Epoch 24/50
24/24 [==============================] - 3s 86ms/step - loss: 0.3229 - accuracy: 0.8849 - val_loss: 0.2734 - val_accuracy: 0.9524
Epoch 25/50
24/24 [==============================] - 3s 87ms/step - loss: 0.3309 - accuracy: 0.8704 - val_loss: 0.2673 - val_accuracy: 0.9524
Epoch 26/50
24/24 [==============================] - 3s 87ms/step - loss: 0.3115 - accuracy: 0.8862 - val_loss: 0.2613 - val_accuracy: 0.9524
Epoch 27/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2988 - accuracy: 0.8889 - val_loss: 0.2565 - val_accuracy: 0.9524
Epoch 28/50
24/24 [==============================] - 3s 87ms/step - loss: 0.3061 - accuracy: 0.8796 - val_loss: 0.2517 - val_accuracy: 0.9524
Epoch 29/50
24/24 [==============================] - 2s 86ms/step - loss: 0.2783 - accuracy: 0.9034 - val_loss: 0.2489 - val_accuracy: 0.9524
Epoch 30/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2839 - accuracy: 0.9048 - val_loss: 0.2417 - val_accuracy: 0.9643
Epoch 31/50
24/24 [==============================] - 2s 83ms/step - loss: 0.2800 - accuracy: 0.9034 - val_loss: 0.2371 - val_accuracy: 0.9643
Epoch 32/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2740 - accuracy: 0.9048 - val_loss: 0.2366 - val_accuracy: 0.9524
Epoch 33/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2806 - accuracy: 0.9021 - val_loss: 0.2292 - val_accuracy: 0.9643
Epoch 34/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2686 - accuracy: 0.8981 - val_loss: 0.2245 - val_accuracy: 0.9643
Epoch 35/50
24/24 [==============================] - 2s 84ms/step - loss: 0.2658 - accuracy: 0.9180 - val_loss: 0.2210 - val_accuracy: 0.9643
Epoch 36/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2574 - accuracy: 0.9021 - val_loss: 0.2190 - val_accuracy: 0.9643
Epoch 37/50
24/24 [==============================] - 3s 85ms/step - loss: 0.2702 - accuracy: 0.9114 - val_loss: 0.2137 - val_accuracy: 0.9643
Epoch 38/50
24/24 [==============================] - 3s 87ms/step - loss: 0.2567 - accuracy: 0.9127 - val_loss: 0.2103 - val_accuracy: 0.9643
Epoch 39/50
24/24 [==============================] - 2s 84ms/step - loss: 0.2477 - accuracy: 0.9206 - val_loss: 0.2075 - val_accuracy: 0.9643
Epoch 40/50
24/24 [==============================] - 3s 86ms/step - loss: 0.2518 - accuracy: 0.9061 - val_loss: 0.2042 - val_accuracy: 0.9643
Epoch 41/50
24/24 [==============================] - 3s 87ms/step - loss: 0.2446 - accuracy: 0.9206 - val_loss: 0.2013 - val_accuracy: 0.9643
Epoch 42/50
24/24 [==============================] - 2s 86ms/step - loss: 0.2342 - accuracy: 0.9127 - val_loss: 0.1979 - val_accuracy: 0.9643
Epoch 43/50
24/24 [==============================] - 2s 82ms/step - loss: 0.2334 - accuracy: 0.9180 - val_loss: 0.1953 - val_accuracy: 0.9643
Epoch 44/50
24/24 [==============================] - 2s 85ms/step - loss: 0.2363 - accuracy: 0.9140 - val_loss: 0.1932 - val_accuracy: 0.9643
Epoch 45/50
24/24 [==============================] - 3s 87ms/step - loss: 0.2370 - accuracy: 0.9101 - val_loss: 0.1911 - val_accuracy: 0.9643
Epoch 46/50
24/24 [==============================] - 3s 87ms/step - loss: 0.2178 - accuracy: 0.9312 - val_loss: 0.1877 - val_accuracy: 0.9643
Epoch 47/50
24/24 [==============================] - 2s 84ms/step - loss: 0.2287 - accuracy: 0.9206 - val_loss: 0.1855 - val_accuracy: 0.9643
Epoch 48/50
24/24 [==============================] - 2s 84ms/step - loss: 0.2263 - accuracy: 0.9193 - val_loss: 0.1835 - val_accuracy: 0.9643
Epoch 49/50
24/24 [==============================] - 3s 87ms/step - loss: 0.2288 - accuracy: 0.9259 - val_loss: 0.1806 - val_accuracy: 0.9643
Epoch 50/50
24/24 [==============================] - 3s 86ms/step - loss: 0.2129 - accuracy: 0.9312 - val_loss: 0.1787 - val_accuracy: 0.9643
CPU times: user 1min 56s, sys: 11.7 s, total: 2min 8s
Wall time: 2min 12s
</code></pre></div>

<h3 id="443-evaluate-model">4.4.3 Evaluate Model<a class="headerlink" href="#443-evaluate-model" title="Permanent link">&para;</a></h3>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set_tf</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_test_</span><span class="p">:</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

         0.0       0.97      0.92      0.95       416
         1.0       0.89      0.95      0.92       262

    accuracy                           0.94       678
   macro avg       0.93      0.94      0.93       678
weighted avg       0.94      0.94      0.94       678






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5da2e393d0&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_71_2.png" /></p>
<h3 id="exercise-4-transfer-learn-with-other-base-models">üèãÔ∏è Exercise 4: Transfer Learn with other Base Models<a class="headerlink" href="#exercise-4-transfer-learn-with-other-base-models" title="Permanent link">&para;</a></h3>
<p>visit <a href="https://www.tensorflow.org/api_docs/python/tf/keras/applications">keras</a> and read about 2-3 of the available models. Choose one and reimplement our transfer learning procedure from above!</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Code cell for exercise 4</span>
</code></pre></div>

<h2 id="45-augmentation-transfer-learning">4.5 Augmentation + Transfer Learning<a class="headerlink" href="#45-augmentation-transfer-learning" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<div class="codehilite"><pre><span></span><code><span class="c1">### COMPONENTS (IN ORDER)</span>
<span class="n">resize</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Resizing</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">)</span>
<span class="n">preprocess_input_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">mobilenet_v2</span><span class="o">.</span><span class="n">preprocess_input</span> 
<span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
                                               <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                               <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span><span class="p">)</span>
<span class="n">base_model</span><span class="o">.</span><span class="n">trainable</span><span class="o">=</span><span class="kc">False</span>
<span class="n">global_average_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()</span>
<span class="n">prediction_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>

<span class="n">aug1</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span> <span class="c1"># flip left-to-right</span>
<span class="n">aug2</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomFlip</span><span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>
<span class="n">aug3</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomContrast</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>
<span class="n">aug4</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">fill_mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_value</span><span class="p">)</span>

<span class="c1">### MODEL</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">image_shape</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">aug1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">aug2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">aug3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">aug4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">preprocess_input_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">base_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">global_average_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">prediction_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">base_learning_rate</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                           <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                           <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Model: &quot;model_2&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_12 (InputLayer)       [(None, 300, 300, 3)]     0

 random_flip_4 (RandomFlip)  (None, 300, 300, 3)       0

 random_flip_5 (RandomFlip)  (None, 300, 300, 3)       0

 random_contrast_2 (RandomCo  (None, 300, 300, 3)      0         
 ntrast)

 random_rotation_2 (RandomRo  (None, 300, 300, 3)      0         
 tation)

 resizing_2 (Resizing)       (None, 224, 224, 3)       0

 tf.math.truediv_2 (TFOpLamb  (None, 224, 224, 3)      0         
 da)

 tf.math.subtract_2 (TFOpLam  (None, 224, 224, 3)      0         
 bda)

 mobilenetv2_1.00_224 (Funct  (None, 7, 7, 1280)       2257984   
 ional)

 global_average_pooling2d_2   (None, 1280)             0         
 (GlobalAveragePooling2D)

 dropout_2 (Dropout)         (None, 1280)              0

 dense_14 (Dense)            (None, 2)                 2562

=================================================================
Total params: 2,260,546
Trainable params: 2,562
Non-trainable params: 2,257,984
_________________________________________________________________


/usr/local/lib/python3.7/dist-packages/keras/optimizer_v2/adam.py:105: UserWarning: The `lr` argument is deprecated, use `learning_rate` instead.
  super(Adam, self).__init__(name, **kwargs)
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">%%</span><span class="n">time</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;/device:GPU:0&#39;</span><span class="p">):</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_set_tf</span><span class="p">,</span>
                      <span class="n">epochs</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">val_set_tf</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stop</span><span class="p">]</span>
                      <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Epoch 1/60
24/24 [==============================] - 6s 121ms/step - loss: 1.1031 - accuracy: 0.4749 - val_loss: 0.7784 - val_accuracy: 0.4405
Epoch 2/60
24/24 [==============================] - 3s 91ms/step - loss: 0.9019 - accuracy: 0.4272 - val_loss: 0.7770 - val_accuracy: 0.5000
Epoch 3/60
24/24 [==============================] - 3s 91ms/step - loss: 0.8208 - accuracy: 0.4828 - val_loss: 0.7223 - val_accuracy: 0.5238
Epoch 4/60
24/24 [==============================] - 3s 91ms/step - loss: 0.7530 - accuracy: 0.5397 - val_loss: 0.6936 - val_accuracy: 0.5476
Epoch 5/60
24/24 [==============================] - 3s 92ms/step - loss: 0.7356 - accuracy: 0.5331 - val_loss: 0.6617 - val_accuracy: 0.5595
Epoch 6/60
24/24 [==============================] - 3s 91ms/step - loss: 0.6974 - accuracy: 0.5714 - val_loss: 0.6388 - val_accuracy: 0.5595
Epoch 7/60
24/24 [==============================] - 3s 88ms/step - loss: 0.6557 - accuracy: 0.5992 - val_loss: 0.6129 - val_accuracy: 0.5833
Epoch 8/60
24/24 [==============================] - 3s 90ms/step - loss: 0.6464 - accuracy: 0.6204 - val_loss: 0.5881 - val_accuracy: 0.6071
Epoch 9/60
24/24 [==============================] - 3s 91ms/step - loss: 0.6505 - accuracy: 0.6270 - val_loss: 0.5684 - val_accuracy: 0.6190
Epoch 10/60
24/24 [==============================] - 3s 88ms/step - loss: 0.5987 - accuracy: 0.6825 - val_loss: 0.5476 - val_accuracy: 0.6429
Epoch 11/60
24/24 [==============================] - 3s 90ms/step - loss: 0.5892 - accuracy: 0.6799 - val_loss: 0.5371 - val_accuracy: 0.6667
Epoch 12/60
24/24 [==============================] - 3s 91ms/step - loss: 0.5802 - accuracy: 0.6878 - val_loss: 0.5172 - val_accuracy: 0.6786
Epoch 13/60
24/24 [==============================] - 3s 88ms/step - loss: 0.5232 - accuracy: 0.7368 - val_loss: 0.5266 - val_accuracy: 0.6429
Epoch 14/60
24/24 [==============================] - 3s 92ms/step - loss: 0.5486 - accuracy: 0.7209 - val_loss: 0.4909 - val_accuracy: 0.6905
Epoch 15/60
24/24 [==============================] - 3s 91ms/step - loss: 0.5099 - accuracy: 0.7646 - val_loss: 0.4740 - val_accuracy: 0.7143
Epoch 16/60
24/24 [==============================] - 3s 88ms/step - loss: 0.5121 - accuracy: 0.7646 - val_loss: 0.4817 - val_accuracy: 0.6786
Epoch 17/60
24/24 [==============================] - 3s 90ms/step - loss: 0.4991 - accuracy: 0.7474 - val_loss: 0.4570 - val_accuracy: 0.7143
Epoch 18/60
24/24 [==============================] - 3s 87ms/step - loss: 0.4878 - accuracy: 0.7672 - val_loss: 0.4622 - val_accuracy: 0.7024
Epoch 19/60
24/24 [==============================] - 3s 89ms/step - loss: 0.4743 - accuracy: 0.7765 - val_loss: 0.4435 - val_accuracy: 0.7262
Epoch 20/60
24/24 [==============================] - 3s 88ms/step - loss: 0.4661 - accuracy: 0.7817 - val_loss: 0.4437 - val_accuracy: 0.7024
Epoch 21/60
24/24 [==============================] - 3s 91ms/step - loss: 0.4671 - accuracy: 0.7778 - val_loss: 0.4418 - val_accuracy: 0.7024
Epoch 22/60
24/24 [==============================] - 3s 89ms/step - loss: 0.4482 - accuracy: 0.7923 - val_loss: 0.4256 - val_accuracy: 0.7143
Epoch 23/60
24/24 [==============================] - 3s 89ms/step - loss: 0.4478 - accuracy: 0.7870 - val_loss: 0.4289 - val_accuracy: 0.7143
Epoch 24/60
24/24 [==============================] - 3s 89ms/step - loss: 0.4124 - accuracy: 0.8214 - val_loss: 0.4237 - val_accuracy: 0.7143
Epoch 25/60
24/24 [==============================] - 3s 88ms/step - loss: 0.4250 - accuracy: 0.8108 - val_loss: 0.4386 - val_accuracy: 0.7024
Epoch 26/60
24/24 [==============================] - 3s 87ms/step - loss: 0.4200 - accuracy: 0.8135 - val_loss: 0.4328 - val_accuracy: 0.7024
Epoch 27/60
24/24 [==============================] - 3s 89ms/step - loss: 0.4195 - accuracy: 0.8122 - val_loss: 0.4139 - val_accuracy: 0.7381
Epoch 28/60
24/24 [==============================] - 3s 91ms/step - loss: 0.4117 - accuracy: 0.8095 - val_loss: 0.4071 - val_accuracy: 0.7500
Epoch 29/60
24/24 [==============================] - 3s 90ms/step - loss: 0.3885 - accuracy: 0.8148 - val_loss: 0.3953 - val_accuracy: 0.7857
Epoch 30/60
24/24 [==============================] - 3s 87ms/step - loss: 0.3774 - accuracy: 0.8452 - val_loss: 0.4010 - val_accuracy: 0.7619
Epoch 31/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3639 - accuracy: 0.8505 - val_loss: 0.4008 - val_accuracy: 0.7500
Epoch 32/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3964 - accuracy: 0.8228 - val_loss: 0.3962 - val_accuracy: 0.7500
Epoch 33/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3644 - accuracy: 0.8320 - val_loss: 0.4159 - val_accuracy: 0.7381
Epoch 34/60
24/24 [==============================] - 3s 90ms/step - loss: 0.3711 - accuracy: 0.8466 - val_loss: 0.3758 - val_accuracy: 0.8095
Epoch 35/60
24/24 [==============================] - 3s 86ms/step - loss: 0.3525 - accuracy: 0.8664 - val_loss: 0.3887 - val_accuracy: 0.7857
Epoch 36/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3470 - accuracy: 0.8571 - val_loss: 0.3953 - val_accuracy: 0.7500
Epoch 37/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3574 - accuracy: 0.8664 - val_loss: 0.3570 - val_accuracy: 0.8214
Epoch 38/60
24/24 [==============================] - 3s 87ms/step - loss: 0.3385 - accuracy: 0.8558 - val_loss: 0.3633 - val_accuracy: 0.8214
Epoch 39/60
24/24 [==============================] - 3s 88ms/step - loss: 0.3500 - accuracy: 0.8532 - val_loss: 0.3698 - val_accuracy: 0.8214
Epoch 40/60
24/24 [==============================] - 3s 85ms/step - loss: 0.3328 - accuracy: 0.8704 - val_loss: 0.3601 - val_accuracy: 0.8214
Epoch 41/60
24/24 [==============================] - 3s 87ms/step - loss: 0.3434 - accuracy: 0.8611 - val_loss: 0.3646 - val_accuracy: 0.8214
Epoch 42/60
24/24 [==============================] - 3s 90ms/step - loss: 0.3339 - accuracy: 0.8690 - val_loss: 0.3656 - val_accuracy: 0.8095
CPU times: user 1min 40s, sys: 10.3 s, total: 1min 50s
Wall time: 2min 38s
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_set_tf</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ds_test_</span><span class="p">:</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">predictions</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>              precision    recall  f1-score   support

         0.0       0.78      1.00      0.88       416
         1.0       0.99      0.56      0.72       262

    accuracy                           0.83       678
   macro avg       0.88      0.78      0.80       678
weighted avg       0.86      0.83      0.81       678






&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5eb6a05a10&gt;
</code></pre></div>

<p><img alt="png" src="../S4_Computer_Vision_II_files/S4_Computer_Vision_II_78_2.png" /></p>
<h2 id="46-summary">4.6 Summary<a class="headerlink" href="#46-summary" title="Permanent link">&para;</a></h2>
<p><a href="#top">back to top</a></p>
<p>If you ran this notebook as-is you should've gotten something similar to the following table</p>
<table>
<thead>
<tr>
<th>Data Handling</th>
<th>Model</th>
<th>Data Augmentation</th>
<th>Weighted F1</th>
<th>Training Time (min:sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ImageDataGenerator</td>
<td>CNN</td>
<td>No</td>
<td>0.96</td>
<td>1:00</td>
</tr>
<tr>
<td>from_directory</td>
<td>CNN</td>
<td>No</td>
<td>0.86</td>
<td>0:39</td>
</tr>
<tr>
<td>from_tensor</td>
<td>CNN</td>
<td>No</td>
<td>0.77</td>
<td>0:47</td>
</tr>
<tr>
<td>from_directory</td>
<td>CNN</td>
<td>Yes</td>
<td>0.93</td>
<td>2:04</td>
</tr>
<tr>
<td>from_directory</td>
<td>MobileNetV2</td>
<td>No</td>
<td>0.94</td>
<td>3:41</td>
</tr>
</tbody>
</table>
<p>In conclusion, we can see an appreciable difference in speed when we decide to transfer learn or augment the original dataset. Curiously, Loading our data with scikit-image gives us the best performance in our custom CNN model.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../S3_Computer_Vision_I/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Computer Vision I" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Computer Vision I
            </div>
          </div>
        </a>
      
      
        
        <a href="../S5_Flask/" class="md-footer__link md-footer__link--next" aria-label="Next: Applications with Flask" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Applications with Flask
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>